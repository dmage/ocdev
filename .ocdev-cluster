#!/bin/bash -efu

usage() {
    echo "usage: $OCDEV_PROGNAME <command>"
    echo
    echo "Available commands:"
    echo "  build        Build oc, openshift, pod and registry binaries"
    echo "  build-image  Build oc and Docker images"
    echo "  up           Start the cluster in Docker"
    echo "  down         Stop the cluster in Docker"
    echo "  destroy      Stop and destroy the cluster"
}

ocdevcluster-build() {
    cdpkg "$OCDEV_ORIGIN_PACKAGE"
    ocdev build cmd/oc
    ocdev openshift build
    ocdev registry build
}

ocdevcluster-build-image() {
    cdpkg "$OCDEV_ORIGIN_PACKAGE"
    ocdev build cmd/oc
    ocdev openshift build-image
    ocdev pod build-image
    ocdev registry build-image
}

ocdevcluster-up() {
    ocdev openshift up
    local i
    for i in {1..20}; do
        [ "$(ocdefault get clusterroles 2>/dev/null | wc -l)" -eq 0 ] || break
        sleep 0.1
    done
    ocdev openshift create-defaults
    ocdev registry up
}

ocdevcluster-down() {
    ocdev openshift down
}

ocdevcluster-destroy() {
    ocdev openshift down
    ocdev openshift destroy
}

ocdevutil-main ".ocdevcluster-" "ocdevcluster-" "$@"
